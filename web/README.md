# Авто-Учёт (CAR-CRM-V2)

Веб-приложение на Next.js 14 для учёта автомобилей, капитала и распределения прибыли между инвестором, владельцем и помощником.

## Быстрый старт

```bash
pnpm install
pnpm prisma migrate dev
pnpm db:seed
pnpm dev
```

Приложение будет доступно на http://localhost:3000. Демонстрационные учётные данные создаются сидом (магические ссылки на указанные e-mail).

## Скрипты

| Команда | Назначение |
| --- | --- |
| `pnpm dev` | запуск в режиме разработки |
| `pnpm build` / `pnpm start` | сборка и запуск в production-режиме |
| `pnpm test` | unit-тесты Vitest |
| `pnpm test:coverage` | покрытие тестами |
| `pnpm prisma migrate dev` | прогон миграций для SQLite |
| `pnpm db:seed` | заполнение демо-данными |

## Docker

Для локального запуска в контейнере:

```bash
docker compose up --build
```

Приложение доступно на http://localhost:3000, данные SQLite сохраняются в каталоге репозитория.

## Структура отчётности и функционал

- Дашборд с KPI, графиком cashflow и распределением прибыли.
- Список авто с быстрыми действиями (расход, доход, смена статуса).
- Карточка VIN с таймлайном операций, расчётом долей и кнопкой выплаты.
- Раздел капитала с журналом движений, фильтрами, экспортом CSV и быстрыми кнопками депозита/вывода.
- Отчёты с фильтрами по диапазону дат, сводкой по VIN, расходам и источникам, экспортом CSV.
- Автоматическая подстановка FX-курса в формах (по справочнику `/api/fxrate`).

## Тесты

Тесты сосредоточены на критичной бизнес-логике (агрегация отчётов, переходы статусов авто):

```bash
pnpm test
```

Отчёты о покрытии формируются в `coverage/`.

## Полезные переменные окружения

- `DATABASE_URL` — путь к SQLite (по умолчанию `file:./prisma/dev.db`).
- `NEXTAUTH_SECRET`, `NEXTAUTH_URL` — параметры NextAuth.
- SMTP-переменные `EMAIL_SERVER_*`, `EMAIL_FROM` — для отправки магических ссылок (по умолчанию используется вывод в консоль).

